#!/bin/zsh
# Pre-commit hook for Claude documentation linting
# Install: ln -sf ${DOTRCDIR}/claude/scripts/pre-commit-lint ${DOTRCDIR}/.git/hooks/pre-commit
#
# This hook checks modified markdown files in the claude/ directory
# for format consistency before allowing commits.

set -uo pipefail

# Get script directory and lint script path
SCRIPT_DIR="${0:A:h}"
LINT_SCRIPT="${SCRIPT_DIR}/lint-docs.sh"

# Check if lint script exists
if [[ ! -x "$LINT_SCRIPT" ]]; then
    echo "Warning: Lint script not found at $LINT_SCRIPT"
    echo "Skipping documentation lint check"
    exit 0
fi

# Get list of staged markdown files in claude/ directory
changed_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^claude/.*\.md$' || true)

# Skip if no relevant files changed
if [[ -z "$changed_files" ]]; then
    exit 0
fi

echo "Checking Claude documentation format..."
echo ""

# Run lint on changed files
failed=0
while IFS= read -r file; do
    if [[ -f "$file" ]]; then
        # Capture output and check exit code
        output=$("$LINT_SCRIPT" "$file" 2>&1)
        exit_code=$?

        if (( exit_code != 0 )); then
            echo "$output"
            failed=1
        fi
    fi
done <<< "$changed_files"

if (( failed )); then
    echo ""
    echo "Documentation lint failed. Please fix the issues above before committing."
    echo "You can run: ./claude/scripts/lint-docs.sh --all"
    exit 1
fi

echo "Documentation lint passed!"
exit 0
